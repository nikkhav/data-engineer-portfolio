# Создание таблиц сущностей для витрины курьеров
Данные курьеров поступают из API сервиса доставки.

Состав витрины **cdm.dm_courier_ledger**:
- **id** - Уникальный идентификатор записи (генерируется автоматически)
- **courier_id** - Идентификатор курьера
- **courier_name** - Имя курьера
- **settlement_year** - Год отчёта
- **settlement_month** - Месяц отчёта
- **orders_count** - Количество заказов за период (месяц)
- **orders_total_sum** - Общая сумма заказов за период (месяц)
- **rate_avg** - Средний рейтинг курьера по оценкам пользователей
- **order_processing_fee** - Сумма, удержанная компанией за обработку заказов (orders_total_sum * 0.25)
- **courier_order_sum** - сумма, которую необходимо перечислить курьеру за доставленные им/ей заказы (рассчитывается по формуле ниже)
- **courier_tips_sum** - сумма, которую пользователи оставили курьеру в качестве чаевых.
- **courier_reward_sum** - сумма, которую необходимо перечислить курьеру. Вычисляется как **courier_order_sum** + **courier_tips_sum** * 0.95 (5% — комиссия за обработку платежа).

Размер выплаты за каждый заказ зависит от **среднего рейтинга курьера** (`r`) в расчётном месяце:
<table>
  <thead>
    <tr>
      <th>Условие по рейтингу r</th>
      <th>Процент от суммы заказа</th>
      <th>Минимальная выплата за заказ</th>
    </tr>
  </thead>
  <tbody>
    <tr><td>r < 4.0</td><td>5%</td><td>100 ₽</td></tr>
    <tr><td>4.0 ≤ r < 4.5</td><td>7%</td><td>150 ₽</td></tr>
    <tr><td>4.5 ≤ r < 4.9</td><td>8%</td><td>175 ₽</td></tr>
    <tr><td>r ≥ 4.9</td><td>10%</td><td>200 ₽</td></tr>
  </tbody>
</table>

## Список таблиц в слое DDS для создания витрины курьеров:
- **dds.fct_product_sales** - фактовая таблица продаж (Уже создана)
- **dds.fct_deliveries** - фактовая таблица доставок (Необходимо создать)
- **dds.dm_couriers** - таблица измерений курьеров (Необходимо создать)
- **dds.dm_timestamps** - таблица временных меток (Уже создана)

## Наполнение таблиц dds из источника API
### 1. Таблица dds.dm_couriers
- **id** - Уникальный идентификатор курьера в нашей системе (PK)
- **courier_id** - Идентификатор курьера из API
- **courier_name** - Имя курьера

### 2. Таблица dds.fct_deliveries
- **id** - Уникальный идентификатор записи (PK)
- **courier_id** - Идентификатор курьера (FK на dds.dm_couriers)
- **order_id** - Идентификатор заказа (FK на dds.fct_product_sales)
- **delivery_ts** - Временная метка доставки
- **rate** - Рейтинг курьера за доставку (от 1 до 5)
- **tip_amount** - Сумма чаевых, оставленных пользователем курьеру

### 3. Таблица dds.fct_product_sales (уже создана)
Добавить поле:
- **courier_id** - Идентификатор курьера (FK на dds.dm_couriers)